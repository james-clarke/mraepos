{% extends "base/base.html" %}

{% block title %}MRA ePOS v2 - Dashboard{% endblock %}
{% block main_class %}dashboard-main{% endblock %}

{% block header_left %}
  <form method="get" id="session-form" class="session-selector">
    <label class="muted" for="session-type">Session</label>
    <select name="session_type" id="session-type">
      {% for st in session_types %}
        <option value="{{ st.id }}"
                {% if current_session_type and st.id == current_session_type.id %}selected{% endif %}>
          {{ st.name }}
        </option>
      {% endfor %}
    </select>
  </form>
{% endblock %}

{% block header_right %}
  <a href="{% url 'admin:index' %}">Admin</a>
  <a href="{% url 'dashboard:financials' %}">Financials</a>
  <span class="muted">Logged in as <strong>{{ request.user.username }}</strong></span>
  <a href="{% url 'logout' %}" class="btn btn-ghost">Logout</a>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
  <section class="card dashboard-products">
    <div class="dashboard-products-header">
      <h1>
        {% if current_session_type %}
          {{ current_session_type.name }}
        {% else %}
          No session type selected
        {% endif %}
      </h1>
      {% if current_session_type %}
        <span class="muted">Tap to add to cart</span>
      {% endif %}
    </div>

    {% if merch_products or addon_products or event_products %}

      {% if event_products %}
        <h3 class="product-section-title">Session products</h3>
        <div class="product-grid">
          {% for sp in event_products %}
            <button type="button"
                    class="product-button"
                    data-product-id="{{ sp.product.id }}">
              <div class="product-name">{{ sp.product.name }}</div>
              <div class="product-price-pill">£{{ sp.price }}</div>
            </button>
          {% endfor %}
        </div>
      {% endif %}

      {% if addon_products %}
        <h3 class="product-section-title">Add-ons</h3>
        <div class="product-grid">
          {% for sp in addon_products %}
            <button type="button"
                    class="product-button"
                    data-product-id="{{ sp.product.id }}">
              <div class="product-name">{{ sp.product.name }}</div>
              <div class="product-price-pill">£{{ sp.price }}</div>
            </button>
          {% endfor %}
        </div>
      {% endif %}

      {% if merch_products %}
        <h3 class="product-section-title">Merchandise</h3>
        <div class="product-grid">
          {% for sp in merch_products %}
            <button type="button"
                    class="product-button"
                    data-product-id="{{ sp.product.id }}">
              <div class="product-name">{{ sp.product.name }}</div>
              <div class="product-price-pill">£{{ sp.price }}</div>
            </button>
          {% endfor %}
        </div>
      {% endif %}

    {% else %}
      <p class="muted">No products configured for this session type.</p>
    {% endif %}
  </section>

  <aside class="card cart-wrapper">
    <div class="cart-header">
      <h2>Cart</h2>
      <span class="muted">Real-time total</span>
    </div>

    <div class="cart-table-wrapper">
      <table class="cart-table" id="cart-table">
        <thead>
        <tr>
          <th>Item</th>
          <th>Qty</th>
          <th>Price</th>
          <th>Line</th>
          <th></th>
        </tr>
        </thead>
        <tbody>
        {% if cart.items %}
          {% for item in cart.items.values %}
            <tr data-product-id="{{ item.product_id }}">
              <td>{{ item.name }}</td>
              <td><input type="number" min="1" class="cart-qty" value="{{ item.quantity }}"></td>
              <td>{{ item.price }}</td>
              <td></td>
              <td><button type="button" class="remove-item">×</button></td>
            </tr>
          {% endfor %}
        {% else %}
          <tr class="empty-row">
            <td colspan="5" class="muted">Cart is empty</td>
          </tr>
        {% endif %}
        </tbody>
      </table>
    </div>

    <div class="cart-summary">
      <div>Items: <span id="cart-item-count">{{ cart_summary.item_count }}</span></div>
      <div>Total: £<span id="cart-total">{{ cart_summary.total }}</span></div>
    </div>

    <div class="cart-actions">
      <button type="button" id="clear-cart" class="btn btn-ghost">Clear cart</button>
      <button type="button" id="checkout" class="btn btn-primary">Checkout complete</button>
    </div>

    <div id="cart-message"></div>
  </aside>
</div>
{% endblock %}

{% block extra_head %}
<script>
  $(function () {
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    $.ajaxSetup({
      headers: {'X-CSRFToken': csrftoken}
    });

    $('#session-type').on('change', function () {
      $('#session-form').submit();
    });

    function updateCartUI(cart, summary) {
      const $tbody = $('#cart-table tbody');
      $tbody.empty();

      const items = cart.items || {};
      const keys = Object.keys(items);

      if (keys.length === 0) {
        $tbody.append('<tr class="empty-row"><td colspan="5" class="muted">Cart is empty</td></tr>');
      } else {
        keys.forEach(function (key) {
          const item = items[key];
          const lineTotal = (parseFloat(item.price) * item.quantity).toFixed(2);
          const rowHtml = `
            <tr data-product-id="${item.product_id}">
              <td>${item.name}</td>
              <td><input type="number" min="1" class="cart-qty" value="${item.quantity}"></td>
              <td>${item.price}</td>
              <td>${lineTotal}</td>
              <td><button type="button" class="remove-item">×</button></td>
            </tr>`;
          $tbody.append(rowHtml);
        });
      }

      $('#cart-item-count').text(summary.item_count);
      $('#cart-total').text(summary.total);
    }

    $('.product-grid').on('click', '.product-button', function () {
      const productId = $(this).data('product-id');

      $.post("{% url 'dashboard:cart_add' %}", {
        product_id: productId,
        quantity: 1
      }).done(function (data) {
        updateCartUI(data.cart, data.summary);
        $('#cart-message').text('Item added').fadeIn().delay(500).fadeOut();
      }).fail(function (xhr) {
        alert('Error adding item: ' + xhr.responseText);
      });
    });

    $('#cart-table').on('change', '.cart-qty', function () {
      const $row = $(this).closest('tr');
      const productId = $row.data('product-id');
      const qty = $(this).val();

      $.post("{% url 'dashboard:cart_update' %}", {
        product_id: productId,
        quantity: qty
      }).done(function (data) {
        updateCartUI(data.cart, data.summary);
      }).fail(function (xhr) {
        alert('Error updating item: ' + xhr.responseText);
      });
    });

    $('#cart-table').on('click', '.remove-item', function () {
      const $row = $(this).closest('tr');
      const productId = $row.data('product-id');

      $.post("{% url 'dashboard:cart_update' %}", {
        product_id: productId,
        quantity: 0
      }).done(function (data) {
        updateCartUI(data.cart, data.summary);
      }).fail(function (xhr) {
        alert('Error removing item: ' + xhr.responseText);
      });
    });

    $('#clear-cart').on('click', function () {
      $.post("{% url 'dashboard:cart_clear' %}")
        .done(function (data) {
          updateCartUI(data.cart, data.summary);
        }).fail(function (xhr) {
          alert('Error clearing cart: ' + xhr.responseText);
        });
    });

    $('#checkout').on('click', function () {
      if (!confirm('Confirm checkout?')) {
        return;
      }
      $.post("{% url 'dashboard:cart_checkout' %}")
        .done(function (data) {
          updateCartUI(data.cart, data.summary);
          $('#cart-message').text('Order #' + data.order_id + ' completed')
            .fadeIn().delay(1500).fadeOut();
        }).fail(function (xhr) {
          alert('Error checking out: ' + xhr.responseText);
        });
    });
  });
</script>
{% endblock %}

